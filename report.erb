<%
require 'yaml'
require 'active_support/all'
require 'unicode/display_width'

pledges = YAML.load_file('pledges.yml').sort_by { |x| x['date'] }
contracts = Dir['contracts/*.yml'].map { |f| YAML.load_file(f) }

DURATION_PARTS = {
    years: 'yr',
    months: 'mo',
    days: 'dy',
    hours: 'hr',
    minutes: 'mn'
}

$footnotes = []

def pad(str, total_width, side = :left)
  p str
  p total_width
  str_width = Unicode::DisplayWidth.of(str, emoji: true)

  if str_width <= total_width
    padding = (" " * (total_width - str_width))
    if side == :left
      str + padding
    else
      padding + str
    end
  else
    $footnotes.push str

    pad("*#{$footnotes.length}", total_width, side)
  end
end
%>
NOTARY'S REPORT OF <%= Time.now.strftime('%^B %d %Y') %>

An up-to-date version of this report is available online at
https://agoranomic.org/Notary/.


<% if contracts.length == 1 %>There is one non-invisible contract.<% else %>There are <%= contracts.length %> non-invisible contracts.<% end %>
<% contracts.each do |contract| %>
=============================== CONTRACT ===============================
|<%= pad(contract['title'], 70) %>|
|PARTIES: <%= pad(contract['parties'].join(', '), 61) %>|
========================================================================
<%= contract['text']
%>========================================================================
<% end %>
<% if pledges.length == 1 %>There is one non-invisible pledge.<% else %>There are <%= pledges.length %> non-invisible pledges.<% end %>
<%
pledges.each do |pledge|
  window = pledge['window'] ? ActiveSupport::Duration.parse("P" + pledge['window']) : 60.days
  window_str = window.parts.map { |type, value| "#{value}#{DURATION_PARTS[type]}" }.join(' ')
  expire = pledge['date'].utc + window
  if expire < Time.now
    puts "pledges.yml contains expired pledge: #{pledge['title']}"
    exit 1
  end
%>
================================ PLEDGE ================================
|<%= pad(pledge['title'], 70 - pledge['by'].length) %><%= pledge['by'] %>|
|MADE: <%= pledge['date'].utc.strftime('%b %d %Y %H:%M') %>|WINDOW: <%= pad(window_str, 5, :right) %>|EXPIRES: <%= (pledge['date'].utc + window).strftime('%b %d %Y %H:%M') %>|N: <%= pad((pledge['n'] || 2).to_s, 2, :right) %>|
========================================================================
<%= pledge['text']
%>========================================================================
<% end
$footnotes.each_with_index do |str, idx| %>
*<%= idx + 1%>: <%= str %><% end %>

The transitional period can end on or after April 27, 2020. At that
point, any invisible contracts or pledges (i.e. those not listed above)
will be destroyed.